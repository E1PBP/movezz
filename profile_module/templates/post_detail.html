{% extends "base.html" %}
{% load static %}
{% load static feeds_extras %}
{% block title %}Post by @{{ post.user.username }}{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 py-8">

  <div class="card w-full bg-base-100 shadow-sm relative overflow-visible">
    {% if is_owner %}
    <div class="dropdown dropdown-end absolute top-3 right-3 z-[9999]">
      <button id="kebabBtn" type="button" tabindex="0" class="btn btn-ghost btn-circle">
      <i data-lucide="more-vertical"></i>
    </button>

    <ul tabindex="0" class="dropdown-content menu p-2 shadow bg-base-100 rounded-box w-40">
      <li>
        <button id="menuEditBtn" type="button" class="flex items-center gap-2">
          <i data-lucide="pencil" class="w-4 h-4"></i>
          <span>Edit Post</span>
        </button>
      </li>
      <li>
        <button id="menuDeleteBtn" type="button" class="flex items-center gap-2 text-red-600">
          <i data-lucide="trash-2" class="w-4 h-4"></i>
          <span>Delete Post</span>
        </button>
      </li>
    </ul>
    </div>
    {% endif %}

    <div class="card-body z-10">

      {% with first_img=post.images.first %}
      {% if first_img or post.image or post.image_url %}

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Header dan Image-->
        <div>
          <div class="flex items-center gap-3">
            <div class="avatar">
              <div class="w-12 h-12 rounded-full overflow-visible">
                {% if post.author_avatar_url %}
                  <img src="{{ post.author_avatar_url }}" alt="{{ post.user.username }}">
                {% elif post.user.profile and post.user.profile.avatar_url %}
                  <img src="{{ post.user.profile.avatar_url.url }}" alt="{{ post.user.username }}">
                {% elif post.user.profile and post.user.profile.avatar %}
                  <img src="{{ post.user.profile.avatar.url }}" alt="{{ post.user.username }}">
                {% else %}
                  <div class="w-12 h-12 rounded-full bg-indigo-600 text-white flex items-center justify-center">
                    <span class="text-lg font-bold">{{ post.user.username|slice:":1"|upper }}</span>
                  </div>
                {% endif %}
              </div>
            </div>

            <div>
              <div class="flex flex-wrap items-center gap-2">
                <span class="font-bold text-lg">
                  {{ post.author_display_name|default:post.user.username }}
                </span>
                <span class="text-neutral-500">@{{ post.user.username }}</span>

                {% if post.author_badges_url %}
                  {% for badge_url in post.author_badges_url|split:"," %}
                    {% if badge_url %}
                      <img src="{{ badge_url }}" alt="Badge" class="w-4 h-4">
                    {% endif %}
                  {% endfor %}
                {% endif %}
              </div>
              {% if post.location_name %}
                <div class="text-sm text-neutral-500">{{ post.location_name }}</div>
              {% endif %}
            </div>
          </div>

          <div class="mt-4 relative w-full aspect-4/3 rounded-lg overflow-hidden">
            {% if first_img and first_img.image %}
              <img src="{{ first_img.image.url }}" alt="Post image" class="absolute w-full h-full object-cover" />
            {% elif post.image %}
              <img src="{{ post.image.url }}" alt="Post image" class="absolute w-full h-full object-cover" />
            {% elif post.image_url %}
              <img src="{{ post.image_url }}" alt="Post image" class="absolute w-full h-full object-cover" />
            {% else %}
              <img src="{% static 'images/logo.svg' %}" alt="Post image" class="absolute w-full h-full object-cover" />
            {% endif %}
          </div>
        </div>

        <div class="flex flex-col justify-between">
          <div>
            <p class="text-neutral-700">
              {% firstof post.text post.caption "" %}
            </p>
            {% if post.created_at %}
              <p class="text-sm text-neutral-400 mt-2">
                Created at : {{ post.created_at|date:"d M, Y" }}
              </p>
            {% endif %}
          </div>

          <div>
            <div class="flex mb-4 flex-wrap gap-2">
              {% for post_hashtag in post.posthashtag_set.all %}
                <span class="badge badge-lg p-3 font-semibold rounded-full text-lime-800 bg-lime-200">
                  #{{ post_hashtag.hashtag.tag }}
                </span>
              {% endfor %}
              {% if post.sport %}
                <span class="badge badge-lg p-3 font-semibold rounded-full text-orange-900 bg-orange-200">
                  #{{ post.sport.name }}
                </span>
              {% endif %}
            </div>

            <div class="flex text-neutral-600 items-center gap-4">
              <div class="flex gap-1 items-center">
                {{ post.likes_count|default:0 }}
                <i data-lucide="heart" class="w-5 h-5 shrink-0"></i>
              </div>
              <div class="flex gap-1 items-center">
                {{ post.comments_count|default:0 }}
                <i data-lucide="message-circle" class="w-5 h-5 shrink-0"></i>
              </div>
              <i data-lucide="share" class="w-5 h-5 shrink-0"></i>
            </div>
          </div>
        </div>
      </div>

      {% else %}
      <div class="flex flex-col gap-5">
          <div class="flex items-center gap-3">
          <div class="avatar">
            <div class="w-12 h-12 rounded-full overflow-hidden">
              {% if post.author_avatar_url %}
                <img src="{{ post.author_avatar_url }}" alt="{{ post.user.username }}">
              {% elif post.user.profile and post.user.profile.avatar_url %}
                <img src="{{ post.user.profile.avatar_url.url }}" alt="{{ post.user.username }}">
              {% elif post.user.profile and post.user.profile.avatar %}
                <img src="{{ post.user.profile.avatar.url }}" alt="{{ post.user.username }}">
              {% else %}
                <div class="w-12 h-12 rounded-full bg-indigo-600 text-white flex items-center justify-center">
                  <span class="text-lg font-bold">{{ post.user.username|slice:":1"|upper }}</span>
                </div>
              {% endif %}
            </div>
          </div>

          <div>
            <div class="flex flex-wrap items-center gap-2">
              <span class="font-bold text-lg">{{ post.author_display_name|default:post.user.username }}</span>
              <span class="text-neutral-500">@{{ post.user.username }}</span>
              {% if author_badges_list %}
                {% for badge_url in author_badges_list %}
                  <img src="{{ badge_url }}" alt="Badge" class="w-4 h-4">
                {% endfor %}
              {% endif %}
            </div>
            {% if post.location_name or post.created_at %}
              <div class="text-sm text-neutral-500 flex items-center gap-2">
                {% if post.location_name %}<span>{{ post.location_name }}</span>{% endif %}
                {% if post.location_name and post.created_at %}<span>â€¢</span>{% endif %}
                {% if post.created_at %}<span>{{ post.created_at|date:"d M, Y" }}</span>{% endif %}
              </div>
            {% endif %}
          </div>
        </div>
        
        <div class="mt-4">
          <p class="text-neutral-700">
            {% firstof post.text post.caption "" %}
          </p>
          {% if post.created_at %}
            <p class="text-sm text-neutral-400 mt-2">
              Created at : {{ post.created_at|date:"d M, Y" }}
            </p>
          {% endif %}

          <div class="flex mt-4 mb-4 flex-wrap gap-2">
            {% for post_hashtag in post.posthashtag_set.all %}
              <span class="badge badge-lg p-3 font-semibold rounded-full text-lime-800 bg-lime-200">
                #{{ post_hashtag.hashtag.tag }}
              </span>
            {% endfor %}
            {% if post.sport %}
              <span class="badge badge-lg p-3 font-semibold rounded-full text-orange-900 bg-orange-200">
                #{{ post.sport.name }}
              </span>
            {% endif %}
          </div>

          <div class="flex text-neutral-600 items-center gap-4">
            <div class="flex gap-1 items-center">
              {{ post.likes_count|default:0 }}
              <i data-lucide="heart" class="w-5 h-5 shrink-0"></i>
            </div>
            <div class="flex gap-1 items-center">
              {{ post.comments_count|default:0 }}
              <i data-lucide="message-circle" class="w-5 h-5 shrink-0"></i>
            </div>
            <i data-lucide="share" class="w-5 h-5 shrink-0"></i>
          </div>
        </div>
      </div>
      {% endif %}
      {% endwith %}
    </div>
  </div>

  <div class="mt-10">
    <h3 class="mt-10 mb-4 font-semibold text-gray-800">More posts from {{ post.user.username }}</h3>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
      {% for p in more_posts %}
        <a href="{% url 'profile_module:post_detail' username=post.user.username pk=p.id %}"
          class="block rounded-xl overflow-hidden bg-white shadow">
          <div class="aspect-square w-full">
            {% with fi=p.images.first %}
              {% if fi and fi.image %}
                <img src="{{ fi.image.url }}" class="w-full h-full object-cover" alt="">
              {% elif p.image %}
                <img src="{{ p.image.url }}" class="w-full h-full object-cover" alt="">
              {% elif p.image_url %}
                <img src="{{ p.image_url }}" class="w-full h-full object-cover" alt="">
              {% elif p.photo_url %}
                <img src="{{ p.photo_url }}" class="w-full h-full object-cover" alt="">
              {% else %}
                <img src="{% static 'images/logo.svg' %}" class="w-full h-full object-cover" alt="">
              {% endif %}
            {% endwith %}
          </div>
        </a>
      {% empty %}
        <p class="text-gray-500">Belum ada post lainnya.</p>
      {% endfor %}
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
  if (window.lucide) { lucide.createIcons(); }

  function getCookie(name) {
    const m = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
    return m ? decodeURIComponent(m[2]) : null;
  }

  const csrftoken = document.querySelector('meta[name="csrf-token"]')?.content || getCookie('csrftoken');
  const updateUrl = "{% url 'profile_module:post_update' pk=post.id %}";
  const deleteUrl = "{% url 'profile_module:post_delete' pk=post.id %}";
  const redirectAfterDelete = "{% url 'profile_module:profile_detail' username=post.user.username %}";

  document.getElementById('editForm')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const res = await fetch(updateUrl, {
      method: "POST",
      headers: { "X-CSRFToken": csrftoken },
      body: new FormData(e.currentTarget)
    });
    const data = await res.json().catch(() => ({}));
    if (res.ok && (data.ok || data.success)) {
      const cb = document.getElementById('edit-modal-toggle');
      if (cb) cb.checked = false;
      location.reload();
    } else {
      alert("Failed to update");
    }
  });

  document.getElementById('confirmDelete')?.addEventListener('click', async () => {
    const res = await fetch(deleteUrl, { method: "POST", headers: { "X-CSRFToken": csrftoken } });
    if (res.ok) window.location.href = redirectAfterDelete;
    else alert("Failed to delete");
  });
</script>
{% endblock %}