{% extends "base.html" %}
{% block title %}Post by @{{ post.author.username }}{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 py-8">
  <article id="postCard" class="bg-white rounded-2xl shadow p-4">
    <header class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="{{ post.author.profile.avatar.url if post.author.profile.avatar }}" class="w-10 h-10 rounded-full object-cover" alt="">
        <div>
          <div class="font-semibold">{{ post.author.profile.display_name|default:post.author.username }}</div>
          <div class="text-sm text-gray-500">@{{ post.author.username }}</div>
        </div>
      </div>
      {% if is_owner %}
      <div class="relative">
        <button id="menuBtn" class="p-2 rounded-full hover:bg-gray-100" aria-haspopup="menu" aria-expanded="false">
          â‹®
        </button>
        <div id="menuPopup" class="absolute right-0 mt-2 w-40 bg-white rounded-lg shadow hidden">
          <button id="openEdit" class="w-full text-left px-4 py-2 hover:bg-gray-50">Edit Post</button>
          <button id="openDelete" class="w-full text-left px-4 py-2 text-red-600 hover:bg-red-50">Delete Post</button>
        </div>
      </div>
      {% endif %}
    </header>

    <div class="mt-4">
      <img src="{{ post.image.url }}" class="w-full rounded-xl" alt="">
    </div>

    <div class="mt-4">
      <p id="captionText" class="leading-relaxed">{{ post.caption|linebreaksbr }}</p>
      <div class="text-xs text-gray-500 mt-2">Created at: {{ post.created_at|date:"j M Y" }}</div>
    </div>
  </article>

  <h3 class="mt-10 mb-4 font-semibold text-gray-800">More posts from {{ post.author.username }}</h3>
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
    {% for p in post.author.posts.all|slice:":6" %}
      {% if p.id != post.id %}
        <a href="{% url 'profilemod:post_detail' post.author.username p.id %}"
           class="block rounded-xl overflow-hidden bg-white shadow">
          <img src="{{ p.image.url }}" class="w-full h-56 object-cover" alt="">
        </a>
      {% endif %}
    {% endfor %}
  </div>
</div>

{% if is_owner %}
<div id="editModal" class="fixed inset-0 bg-black/40 hidden z-50">
  <div class="absolute inset-0 grid place-items-center px-4">
    <div class="bg-white rounded-2xl p-5 w-full max-w-2xl">
      <h3 class="font-semibold text-lg mb-3">Edit Post</h3>
      <form id="editForm">
        {{ form.as_p }}
        <div class="mt-4 flex justify-end gap-3">
          <button type="button" id="cancelEdit" class="px-4 py-2 rounded-lg border">Cancel</button>
          <button type="submit" class="px-4 py-2 rounded-lg bg-green-600 text-white font-semibold">Update</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div id="deleteModal" class="fixed inset-0 bg-black/40 hidden z-50">
  <div class="absolute inset-0 grid place-items-center px-4">
    <div class="bg-white rounded-2xl p-5 w-full max-w-md">
      <h3 class="font-semibold text-lg">Delete Post</h3>
      <p class="text-gray-600 mt-2">Are you sure you want to delete this post?</p>
      <div class="mt-4 flex justify-end gap-3">
        <button id="cancelDelete" class="px-4 py-2 rounded-lg border">Cancel</button>
        <button id="confirmDelete" class="px-4 py-2 rounded-lg bg-red-600 text-white font-semibold">Delete</button>
      </div>
    </div>
  </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
  const csrftoken = document.querySelector('meta[name="csrf-token"]')?.content;

  const menuBtn = document.getElementById('menuBtn');
  const menuPopup = document.getElementById('menuPopup');
  if (menuBtn && menuPopup) {
    menuBtn.addEventListener('click', () => menuPopup.classList.toggle('hidden'));
    document.addEventListener('click', (e)=> {
      if (!menuPopup.contains(e.target) && e.target !== menuBtn) menuPopup.classList.add('hidden');
    });
  }

  const editModal = document.getElementById('editModal');
  const deleteModal = document.getElementById('deleteModal');
  const openEdit = document.getElementById('openEdit');
  const openDelete = document.getElementById('openDelete');
  const cancelEdit = document.getElementById('cancelEdit');
  const cancelDelete = document.getElementById('cancelDelete');

  if (openEdit) openEdit.onclick = () => { editModal.classList.remove('hidden'); menuPopup.classList.add('hidden'); };
  if (openDelete) openDelete.onclick = () => { deleteModal.classList.remove('hidden'); menuPopup.classList.add('hidden'); };
  if (cancelEdit) cancelEdit.onclick = () => editModal.classList.add('hidden');
  if (cancelDelete) cancelDelete.onclick = () => deleteModal.classList.add('hidden');

  // Update Caption
  const editForm = document.getElementById('editForm');
  if (editForm) {
    editForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(editForm);
      const res = await fetch("{% url 'profilemod:post_update' post.id %}", {
        method: "POST",
        headers: { "X-CSRFToken": csrftoken },
        body: formData
      });
      const data = await res.json();
      if (res.ok && data.ok) {
        document.getElementById('captionText').innerHTML = data.caption.replaceAll("\n","<br>");
        editModal.classList.add('hidden');
      } else {
        alert("Failed to update");
      }
    });
  }

  // Delete (AJAX)
  const confirmDelete = document.getElementById('confirmDelete');
  if (confirmDelete) {
    confirmDelete.addEventListener('click', async () => {
      const res = await fetch("{% url 'profilemod:post_delete' post.id %}", {
        method: "POST",
        headers: { "X-CSRFToken": csrftoken }
      });
      if (res.ok) {
        window.location.href = "{% url 'profilemod:profile' post.author.username %}";
      } else {
        alert("Failed to delete");
      }
    });
  }
</script>
{% endblock %}
