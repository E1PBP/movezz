{% extends "base.html" %} {% load static %} {% load feeds_extras %} {% block meta %}
<meta
  name="description"
  content="Movezz - your social platform for sharing, broadcasting, and marketplace interactions."
/>
{% endblock meta %} {% block content %}
<div class="flex gap-3">
  <div class="basis-2/3">
    <div
      class="relative basis-2/3 card bg-base-100 shadow-sm overflow-hidden flex-row"
    >
      <div class="card-body gap-3 z-10 flex flex-row">
        <div
          class="w-10 h-10 border border-white rounded-full bg-primary text-primary-content flex items-center justify-center overflow-hidden"
        >
          {% if user.is_authenticated and user_avatar_url %}
          <img
            src="{{ user_avatar_url }}"
            alt="{{ user.get_full_name|default:user.username }}"
            class="object-cover w-full h-full"
          />
          {% else %}
          <span class="text-sm font-bold"
            >{{ user.username|slice:":1"|upper }}</span
          >
          {% endif %}
        </div>
        <form id="post-form-pre" class="relative w-full">
          {% csrf_token %} {{ form.text }}
          <div
            class="card-actions items-center justify-end absolute right-3 bottom-3 gap-6"
          >
            <button
              type="button"
              class="btn btn-primary bg-lime-500 border-lime-500 hover:bg-lime-600 hover:border-lime-600 text-white"
              onclick="openPostModal()"
            >
              Post
            </button>
          </div>
        </form>
      </div>
      <img
        src="{% static 'images/postcard-bg.webp' %}"
        alt="bg"
        class="absolute w-full h-full object-cover scale-105"
      />
    </div>
    <div class="mt-4">
      <div role="tablist" class="tabs tabs-border w-full text-lime-500 mb-2">
        <a href="?tab=foryou" role="tab" class="tab hover:text-lime-600 w-1/2 {% if active_tab == 'foryou' %}tab-active{% endif %}">For You</a>
        <a href="?tab=following" role="tab" class="tab hover:text-lime-600 w-1/2 {% if active_tab == 'following' %}tab-active{% endif %}">Following</a>
      </div>
      <div class="space-y-4">
        {% for post in posts %}
        <div class="card w-full bg-base-100 shadow-sm overflow-hidden relative">
            <div class="card-body z-10">
                {% if post.images.all %}
                {# Layout for posts WITH an image (Two Columns) #}
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Left Column -->
                    <div>
                        <div class="flex items-center gap-3">
                            <div class="avatar">
                                <div class="w-12 rounded-full">
                                    {% if post.author_avatar_url %}
                                    <img src="{{ post.author_avatar_url }}" alt="{{ post.author_display_name }}" />
                                    {% else %}
                                    <div class="w-12 h-12 bg-primary text-primary-content flex items-center justify-center">
                                        <span class="text-xl font-bold">{{ post.user.username|slice:":1"|upper }}</span>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div>
                                <div class="flex items-center gap-2">
                                    <span class="font-bold text-lg">{{ post.author_display_name|default:post.user.username }}</span>
                                    <span class="text-neutral-500">@{{ post.user.username }}</span>
                                    {% if post.author_badges_url %}
                                        {% for badge_url in post.author_badges_url|split:"," %}
                                            {% if badge_url %}
                                            <img src="{{ badge_url }}" alt="Badge" class="w-4 h-4">
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                </div>
                                <div class="text-sm text-neutral-500">{{ post.location_name }}</div>
                            </div>
                        </div>
                        <div class="mt-4 relative w-full aspect-4/3 rounded-lg overflow-hidden">
                            <img src="{{ post.images.first.image.url }}" alt="Post image" class="absolute w-full h-full object-cover" />
                        </div>
                    </div>
                    <!-- Right Column -->
                    <div class="flex flex-col justify-between">
                        <div>
                            <p class="text-neutral-700">{{ post.text }}</p>
                            <p class="text-sm text-neutral-400 mt-2">Created at : {{ post.created_at|date:"d M, Y" }}</p>
                        </div>
                        <div>
                            <div class="flex mb-4 flex-wrap gap-2">
                                {% for post_hashtag in post.posthashtag_set.all %}
                                <span class="badge badge-lg p-3 font-semibold rounded-full text-lime-800 bg-lime-200">
                                    #{{ post_hashtag.hashtag.tag }}
                                </span>
                                {% endfor %}
                                {% if post.sport %}
                                <span class="badge badge-lg p-3 font-semibold rounded-full text-orange-900 bg-orange-200">
                                    #{{ post.sport.name }}
                                </span>
                                {% endif %}
                            </div>
                            <div class="flex text-neutral-600 items-center gap-4">
                                <div class="flex gap-1 items-center">
                                    {{ post.likes_count }}
                                    <i data-lucide="heart" class="w-5 h-5 shrink-0"></i>
                                </div>
                                <div class="flex gap-1 items-center">
                                    {{ post.comments_count }}
                                    <i data-lucide="message-circle" class="w-5 h-5 shrink-0"></i>
                                </div>
                                <i data-lucide="share" class="w-5 h-5 shrink-0"></i>
                            </div>
                        </div>
                    </div>
                </div>
                {% else %}
                {# Layout for posts WITHOUT an image (Single Column) #}
                <div>
                    <div class="flex items-center gap-3">
                        <div class="avatar">
                            <div class="w-12 rounded-full">
                                {% if post.author_avatar_url %}
                                <img src="{{ post.author_avatar_url }}" alt="{{ post.author_display_name }}" />
                                {% else %}
                                <div class="w-12 h-12 bg-primary text-primary-content flex items-center justify-center">
                                    <span class="text-xl font-bold">{{ post.user.username|slice:":1"|upper }}</span>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        <div>
                            <div class="flex items-center gap-2">
                                <span class="font-bold text-lg">{{ post.author_display_name|default:post.user.username }}</span>
                                <span class="text-neutral-500">@{{ post.user.username }}</span>
                                {% if post.author_badges_url %}
                                    {% for badge_url in post.author_badges_url|split:"," %}
                                        {% if badge_url %}
                                        <img src="{{ badge_url }}" alt="Badge" class="w-4 h-4">
                                        {% endif %}
                                    {% endfor %}
                                {% endif %}
                            </div>
                            <div class="text-sm text-neutral-500">{{ post.location_name }}</div>
                        </div>
                    </div>
                    <div class="mt-4">
                        <p class="text-neutral-700">{{ post.text }}</p>
                        <p class="text-sm text-neutral-400 mt-2">Created at : {{ post.created_at|date:"d M, Y" }}</p>
                        <div class="flex mt-4 mb-4 flex-wrap gap-2">
                            {% for post_hashtag in post.posthashtag_set.all %}
                            <span class="badge badge-lg p-3 font-semibold rounded-full text-lime-800 bg-lime-200">
                                #{{ post_hashtag.hashtag.tag }}
                            </span>
                            {% endfor %}
                            {% if post.sport %}
                            <span class="badge badge-lg p-3 font-semibold rounded-full text-orange-900 bg-orange-200">
                                #{{ post.sport.name }}
                            </span>
                            {% endif %}
                        </div>
                        <div class="flex text-neutral-600 items-center gap-4">
                            <div class="flex gap-1 items-center">
                                {{ post.likes_count }}
                                <i data-lucide="heart" class="w-5 h-5 shrink-0"></i>
                            </div>
                            <div class="flex gap-1 items-center">
                                {{ post.comments_count }}
                                <i data-lucide="message-circle" class="w-5 h-5 shrink-0"></i>
                            </div>
                            <i data-lucide="share" class="w-5 h-5 shrink-0"></i>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        {% empty %}
        <div class="card w-full bg-base-100 shadow-sm">
            <div class="card-body">
                <p class="text-center text-neutral-500">No posts to show yet. Follow someone or create your first post!</p>
            </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
  <div class="basis-1/3">
    <div class="card w-full bg-base-100 shadow-sm overflow-hidden relative">
      <div class="card-body z-10 text-white">
        <h1 class="italic font-semibold text-xl mb-2">Upcoming Events</h1>
        <div class="flex">
          <div class="w-full space-y-2">
            <div class="flex gap-2">
              <i data-lucide="calendar-days" class="w-6 h-6"></i>
              Today, 19:00 WIB
            </div>
            <div class="flex gap-2">
              <i data-lucide="map-pin" class="w-6 h-6"></i>
              Lapangan Indraprasta
            </div>
          </div>
          <div class="w-full space-y-2">
            <div class="flex gap-2">
              <i data-lucide="trophy" class="w-6 h-6"></i>
              Intermediate Level
            </div>
            <div class="flex gap-2">
              <i data-lucide="dollar-sign" class="w-6 h-6"></i>
              Rp25.000
            </div>
          </div>
        </div>
        <div class="flex justify-end">
          <button
            type="submit"
            class="btn btn-primary bg-lime-500 border-lime-500 hover:bg-lime-600 hover:border-lime-600 text-white"
          >
            Join Event
          </button>
        </div>
      </div>
      <img
        src="{% static 'images/latest-bg.webp' %}"
        alt="bg"
        class="absolute w-full h-full object-cover scale-105"
      />
    </div>
  </div>
</div>

<dialog id="post-modal" class="modal">
  <div class="modal-box">
    <form id="post-form-final" method="post" enctype="multipart/form-data">
      <h3 class="font-bold text-lg">Create a new post</h3>
      <p class="text-sm text-neutral-500">@{{ user.username }}</p>
      
      <div class="py-4">
        {{ form.text }}
      </div>

      <div class="space-y-3">
        <div class="flex items-center gap-4">
          <div class="flex items-center gap-2 text-lime-500 w-28">
            <i data-lucide="flame" class="w-6 h-6"></i>
            <span>Sport</span>
          </div>
          {{ form.sport }}
        </div>
  
        <div class="flex items-center gap-4">
          <div class="flex items-center gap-2 text-red-500 w-28">
            <i data-lucide="map-pin" class="w-6 h-6"></i>
            <span>Location</span>
          </div>
          {{ form.location_name }}
        </div>
  
        <div class="flex items-center gap-4">
          <div class="flex items-center gap-2 text-orange-500 w-28">
            <i data-lucide="clock" class="w-6 h-6"></i>
            <span>Hour</span>
          </div>
          <input type="number" class="input input-bordered w-full" name="hour" min="0" max="23" placeholder="HH" />
        </div>
      </div>

      <div class="mt-4">
        <label class="block text-sm font-medium text-neutral-600 mb-1">Hashtags (max 5)</label>
        <div id="hashtag-container" class="flex flex-wrap gap-2 p-2 border rounded-lg bg-base-200">
          <input type="text" id="hashtag-input" class="bg-transparent focus:outline-none flex-grow" placeholder="Type a tag and press Enter">
        </div>
        <input type="hidden" name="hashtags" id="hashtags-hidden-input">
      </div>

      <div id="image-preview-container" class="mt-4 hidden relative w-full max-w-36 max-h-36">
        <img id="image-preview" src="#" alt="Image preview" class="rounded-lg object-cover" />
        <button type="button" id="remove-image-btn" class="btn btn-sm btn-circle absolute top-1 right-1 bg-red-500 text-white border-none">
            <i data-lucide="x" class="w-4 h-4"></i>
        </button>
      </div>


      <div class="modal-action">
        <div class="flex items-center gap-2">
          <label for="image-upload" class="btn btn-ghost btn-circle">
            <i data-lucide="image-up" class="w-6 h-6 text-neutral-600"></i>
          </label>
          <input type="file" id="image-upload" name="image" class="hidden" accept="image/*" />
        </div>
        <div class="flex-grow"></div>
        <button
          type="button"
          class="btn btn-ghost"
          onclick="document.getElementById('post-modal').close()"
        >
          Cancel
        </button>
        <button
          type="submit"
          class="btn btn-primary bg-lime-500 border-lime-500 hover:bg-lime-600 hover:border-lime-600 text-white"
        >
          Post
        </button>
      </div>
    </form>
  </div>
</dialog>

<script>
  lucide.createIcons();

  function openPostModal() {
    const text = document.querySelector(
      '#post-form-pre textarea[name="text"]'
    ).value;
    document.querySelector('#post-form-final textarea[name="text"]').value =
      text;
    document.getElementById("post-modal").showModal();
  }

  const hashtagContainer = document.getElementById('hashtag-container');
  const hashtagInput = document.getElementById('hashtag-input');
  const hiddenInput = document.getElementById('hashtags-hidden-input');
  let hashtags = [];

  const imageUpload = document.getElementById('image-upload');
  const imagePreviewContainer = document.getElementById('image-preview-container');
  const imagePreview = document.getElementById('image-preview');
  const removeImageBtn = document.getElementById('remove-image-btn');

  function renderHashtags() {
    // Remove only the existing hashtag chips, not the input field
    const chips = hashtagContainer.querySelectorAll('div.badge');
    chips.forEach(chip => chip.remove());

    hashtags.forEach(tag => {
      const chip = document.createElement('div');
      chip.className = 'badge badge-neutral gap-2';
      chip.textContent = `#${tag}`;
      
      const removeBtn = document.createElement('span');
      removeBtn.className = 'cursor-pointer';
      removeBtn.innerHTML = '&times;';
      removeBtn.onclick = () => {
        hashtags = hashtags.filter(t => t !== tag);
        renderHashtags();
      };
      
      chip.appendChild(removeBtn);
      hashtagContainer.insertBefore(chip, hashtagInput);
    });
    hiddenInput.value = hashtags.join(',');
    hashtagInput.focus();
  }

  imageUpload.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(event) {
        imagePreview.src = event.target.result;
        imagePreviewContainer.classList.remove('hidden');
        lucide.createIcons(); // Redraw icons if needed
      }
      reader.readAsDataURL(file);
    }
  });

  removeImageBtn.addEventListener('click', function() {
    imageUpload.value = ''; // Clear the file input
    imagePreview.src = '#';
    imagePreviewContainer.classList.add('hidden');
  });

  hashtagInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && hashtagInput.value.trim() !== '') {
      e.preventDefault();
      const newTag = hashtagInput.value.trim().replace(/[^a-zA-Z0-9]/g, '');
      if (newTag && !hashtags.includes(newTag) && hashtags.length < 5) {
        hashtags.push(newTag);
        hashtagInput.value = '';
        renderHashtags();
      }
    }
  });

  document
    .getElementById("post-form-final")
    .addEventListener("submit", function (e) {
      e.preventDefault();

      let formData = new FormData(this);
      
      fetch("{% url 'feeds_module:create_post_ajax' %}", {
        method: "POST",
        body: formData,
        headers: {
          "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value,
        },
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.status === "success") {
            window.location.reload();
          } else {
            console.error("Error:", data.errors);
          }
        })
        .catch((error) => {
          console.error("Error:", error);
        });
    });
</script>
{% endblock content %}
