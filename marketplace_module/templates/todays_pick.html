{% extends 'base_marketplace.html' %}
{% load static currency %}

{% block marketplace_content %}

<h1 class="text-2xl sm:text-3xl font-semibold tracking-tight mb-6">Today's Pick</h1>

<script id="mp-config" type="application/json">
  {{ page_config_json|safe }}
</script>

<!-- FILTER BAR -->
<div
  class="flex flex-col sm:flex-row sm:items-center mb-8 bg-white rounded-lg border border-gray-200 p-4 gap-3 sm:gap-4">
  
  {% if user.is_authenticated %}
  <!-- Create Product -->
  <button
    id="open-create-modal"
    type="button"
    class="order-1 btn btn-primary bg-lime-500 border-lime-500 hover:bg-lime-600 hover:border-lime-600 text-white"
    onclick="showListingModal()">
    <i data-lucide="plus" class="w-4 h-4"></i>
    <span class="hidden xs:inline">Create Product</span>
  </button>
  {% endif %}


  <!-- search -->
  <label
    class="order-2 input input-sm sm:input-md input-bordered flex items-center gap-2 w-full sm:w-72 md:w-[28rem] flex-1">
    <svg class="h-[1em] opacity-50 shrink-0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
      <g stroke-linejoin="round" stroke-linecap="round" stroke-width="2.5" fill="none" stroke="currentColor">
        <circle cx="11" cy="11" r="8"></circle>
        <path d="m21 21-4.3-4.3"></path>
      </g>
    </svg>
    <input id="input-search" type="search" class="grow" required placeholder="Search" />
  </label>

  <!-- filter button chip -->
  <div class="order-3 w-full sm:w-auto overflow-x-auto">
    <div class="join whitespace-nowrap">
      <button id="chip-all"  type="button"
              class="btn btn-sm join-item text-neutral-900 bg-base-200 border-base-200 hover:bg-base-300 active:bg-base-400">
        All
      </button>
      <button id="chip-new"  type="button"
              class="btn btn-sm join-item text-neutral-900 bg-[#A3E635] border-[#A3E635] hover:bg-[#8FD542] active:bg-[#7BC536]">
        Brand New
      </button>
      <button id="chip-used" type="button"
              class="btn btn-sm join-item text-neutral-900 bg-[#FB923C] border-[#FB923C] hover:bg-[#FFA24F] active:bg-[#F78E2D]">
        Used
      </button>
    </div>
  </div>

  {% if user.is_authenticated %}
  <!-- wishlist -->
  <a href="{% url 'marketplace_module:wishlist_page' %}"
     class="order-4 btn bg-[#FFEEF0] border-[#FFEEF0] text-rose-600 hover:bg-[#FFE3E7] hover:border-[#FFE3E7]">
    <i data-lucide="heart" class="w-4 h-4"></i>
    <span class="hidden xs:inline">Wishlist</span>
  </a>
  {% endif %}

  <!-- refresh -->
  <button id="btn-refresh" class="order-5 btn btn-xs sm:btn-sm sm:ml-auto">
    <span class="hidden sm:inline">Refresh</span>
    <i data-lucide="refresh-ccw" class="w-4 h-4 sm:ml-1"></i>
  </button>
</div>

<!-- states -->
<div id="loading" class="bg-base-100 rounded-lg border border-base-200 p-10 text-center hidden">
  <span class="loading loading-spinner loading-md"></span>
  <p class="mt-3 text-base-content/70">Loading listingsâ€¦</p>
</div>
<div id="error" class="bg-base-100 rounded-lg border border-error p-6 text-center hidden">
  <p class="text-error font-semibold">Failed to load data. Please try again.</p>
</div>
<div id="empty" class="bg-base-100 rounded-lg border border-base-200 p-10 text-center hidden">
  <p class="text-base-content/70">No listings found.</p>
</div>

<!-- grid -->
<div id="grid" class="grid grid-cols-1 xs:grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-6 px-2 sm:px-0 hidden"></div>

<script>
  (function () {
    'use strict';

    // config
    const CONFIG = JSON.parse(document.getElementById('mp-config').textContent);
    const API_URL = CONFIG.apiListings;
    const DETAIL_PATTERN = CONFIG.detailUrlPattern;
    const IS_AUTHENTICATED = CONFIG.isAuthenticated;
    const WL_IDS_URL = CONFIG.wishlistIdsUrl || null;
    const WL_TOGGLE_URL = CONFIG.wishlistToggleUrl || null;

    // DOM
    const elements = {
      grid: document.getElementById('grid'),
      loading: document.getElementById('loading'),
      error: document.getElementById('error'),
      empty: document.getElementById('empty'),
      chipAll: document.getElementById('chip-all'),
      chipNew: document.getElementById('chip-new'),
      chipUsed: document.getElementById('chip-used'),
      searchInput: document.getElementById('input-search'),
      refreshBtn: document.getElementById('btn-refresh')
    };

    // state
    let activeCondition = '';
    let wishlistSet = new Set();
    let wishlistLoaded = false;

    function showSection({ loading = false, error = false, empty = false, grid = false }) {
      elements.loading.classList.toggle('hidden', !loading);
      elements.error.classList.toggle('hidden', !error);
      elements.empty.classList.toggle('hidden', !empty);
      elements.grid.classList.toggle('hidden', !grid);
    }

    function setActiveChip(condition) {
      activeCondition = condition;
      [elements.chipAll, elements.chipNew, elements.chipUsed].forEach(b => b.classList.remove('btn-active'));
      if (!condition) elements.chipAll.classList.add('btn-active');
      else if (condition === 'BRAND_NEW') elements.chipNew.classList.add('btn-active');
      else if (condition === 'USED') elements.chipUsed.classList.add('btn-active');
    }

    function formatIDR(n) {
      return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 })
        .format(Number(n || 0));
    }
    const getConditionClasses = c => c === 'BRAND_NEW' ? 'bg-lime-400 text-[#3F6212]' : 'bg-orange-300 text-[#7C2D12]';
    const getConditionLabel = c => c === 'BRAND_NEW' ? 'Brand New' : 'Used';

    // load wishlist IDs
    async function ensureWishlistLoaded() {
      if (!IS_AUTHENTICATED || wishlistLoaded || !WL_IDS_URL) return;
      try {
        const r = await fetch(WL_IDS_URL, { headers: { 'Accept': 'application/json' } });
        if (r.ok) {
          const data = await r.json();
          const ids = Array.isArray(data) ? data : (data.ids || []);
          wishlistSet = new Set(ids.map(String));
          wishlistLoaded = true;
        }
      } catch (_) { }
    }

    // card visual
    function createCardHTML(item) {
      const idStr = String(item.id);
      const isSaved = wishlistSet.has(idStr);
      const safeTitle = DOMPurify.sanitize(item.title);
      const img = DOMPurify.sanitize(item.image_url || '');
      const location = IS_AUTHENTICATED ? DOMPurify.sanitize(item.location || '') : 'Login to view';
      const detailUrl = DETAIL_PATTERN.replace('00000000-0000-0000-0000-000000000000', idStr);

      return `
      <article class="relative card bg-base-100 border border-base-300/60 shadow-sm hover:shadow-md hover:ring-1 hover:ring-base-300 transition-all duration-300 overflow-hidden rounded-[16px] w-full max-w-[422px] mx-auto" style="height:447px;">
        <a href="${detailUrl}" class="absolute inset-0 z-10" aria-label="Open ${safeTitle}"></a>

        <figure class="h-[220px] sm:h-[320px] lg:h-[340px] overflow-hidden pointer-events-none">
          <img src="${img}" alt="${safeTitle}" class="w-full h-full object-cover" loading="lazy" decoding="async"/>
        </figure>

        <div class="absolute top-3 right-3 z-20">
          <button class="wishlist-btn grid place-items-center w-9 h-9 rounded-full bg-white/90 shadow ring-1 ring-black/5 pointer-events-auto ${isSaved ? 'text-rose-500' : 'text-base-content/40 hover:text-rose-500'}"
                  aria-pressed="${isSaved}" title="Save" data-id="${idStr}">
            <svg viewBox="0 0 28 28" class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
              <path d="M14 24.9083L12.3083 23.3683C6.3 17.92 2.33333 14.315 2.33333 9.91667C2.33333 6.31167 5.15666 3.5 8.74999 3.5C10.78 3.5 12.7283 4.445 14 5.92667C15.2717 4.445 17.22 3.5 19.25 3.5C22.8433 3.5 25.6667 6.31167 25.6667 9.91667C25.6667 14.315 21.7 17.92 15.6917 23.3683L14 24.9083Z" fill="currentColor"/>
            </svg>
          </button>
        </div>

        <div class="p-3 sm:p-4 pt-3 pb-3 pointer-events-none" style="height:107px;">
          <p class="text-base sm:text-[20px] leading-[24px] sm:leading-[28px] font-semibold mb-1">${formatIDR(item.price)}</p>
          <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2">
            <h2 class="text-sm sm:text-[18px] leading-[18px] font-semibold line-clamp-1">${safeTitle}</h2>
            <span class="px-3 py-1 text-xs sm:text-[14px] leading-[18px] font-semibold rounded-full ${getConditionClasses(item.condition)}">
              ${getConditionLabel(item.condition)}
            </span>
          </div>
          <div class="mt-2 text-xs sm:text-sm text-base-content/70">
            <span class="truncate">${location}</span>
          </div>
        </div>
      </article>`;
    }

    // fill heart
    function paintWishlistHearts() {
      if (!IS_AUTHENTICATED) return;
      elements.grid.querySelectorAll('.wishlist-btn').forEach(btn => {
        const id = String(btn.dataset.id || '');
        const active = wishlistSet.has(id);
        btn.classList.toggle('text-rose-500', active);
        btn.classList.toggle('text-base-content/40', !active);
        btn.setAttribute('aria-pressed', String(active));
      });
    }

    // heart button listener
    function setupWishlistListeners() {
      elements.grid.addEventListener('click', async (e) => {
        const btn = e.target.closest('.wishlist-btn');
        if (!btn) return;
        e.stopPropagation();

        if (!IS_AUTHENTICATED || !WL_TOGGLE_URL) {
          window.showToast && showToast('Please log in to use wishlist', '', 'error');
          return;
        }
        const id = btn.dataset.id;
        try {
          const fd = new FormData();
          fd.append('listing_id', id);
          const r = await fetch(WL_TOGGLE_URL, { method: 'POST', body: fd });
          if (!r.ok) throw new Error('toggle failed');
          const payload = await r.json();

          if (payload.status === 'added') {
            wishlistSet.add(id);
            window.showToast && showToast('Saved to wishlist', '', 'success');
          } else if (payload.status === 'removed') {
            wishlistSet.delete(id);
            window.showToast && showToast('Removed from wishlist', '', 'normal');
          }
          paintWishlistHearts();
        } catch (err) {
          console.error(err);
          window.showToast && showToast('Wishlist error', 'Please try again', 'error');
        }
      }, { passive: true });
    }

    // fetch and render
    async function fetchAndRender(showToastOnDone = false) {
      try {
        showSection({ loading: true });
        await ensureWishlistLoaded();

        const params = new URLSearchParams();
        if (activeCondition) params.set('condition', activeCondition);
        const q = elements.searchInput.value.trim();
        if (q) params.set('q', q);

        const r = await fetch(`${API_URL}?${params.toString()}`, { headers: { 'Accept': 'application/json' } });
        if (!r.ok) throw new Error('Bad response');
        const raw = await r.json();
        const data = Array.isArray(raw) ? raw.map(x => ({ id: x.pk, ...x.fields })) : [];

        elements.grid.innerHTML = data.length ? data.map(createCardHTML).join('') : '';
        if (!data.length) {
          showSection({ empty: true });
        } else {
          if (window.lucide) window.lucide.createIcons();
          paintWishlistHearts();
          showSection({ grid: true });
        }
        if (showToastOnDone && window.showToast) showToast('Refreshed');
      } catch (err) {
        console.error('Failed to fetch listings:', err);
        showSection({ error: true });
      }
    }

    // better user input handle
    const debounce = (fn, ms = 300) => { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); }; };

    // events
    function setupEventListeners() {
      elements.chipAll.addEventListener('click', () => { setActiveChip(''); fetchAndRender(true); });
      elements.chipNew.addEventListener('click', () => { setActiveChip('BRAND_NEW'); fetchAndRender(true); });
      elements.chipUsed.addEventListener('click', () => { setActiveChip('USED'); fetchAndRender(true); });
      elements.searchInput.addEventListener('input', debounce(() => fetchAndRender(), 250));
      elements.refreshBtn.addEventListener('click', () => fetchAndRender(true));
    }

    // modal events
    document.addEventListener('listing:created', () => fetchAndRender(true));

    // init
    (function init() {
      setupEventListeners();
      setupWishlistListeners();
      fetchAndRender();
    })();

  })();
</script>

{% endblock %}