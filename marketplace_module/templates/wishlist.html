{% extends 'base_marketplace.html' %}
{% load static %}

{% block marketplace_content %}
<h1 class="text-2xl sm:text-3xl font-semibold tracking-tight mb-6">My Wishlist</h1>

<div class="mb-4">
  <a href="{% url 'marketplace_module:todays_pick' %}" class="inline-flex items-center gap-2 rounded-lg border px-3 py-2
            text-sm font-medium bg-white border-gray-200 text-gray-700
            hover:bg-gray-100 hover:border-gray-300 transition-colors">
    <i data-lucide="arrow-left" class="w-4 h-4"></i>
  </a>
</div>

<script id="mp-config" type="application/json">
  {{ page_config_json|safe }}
</script>

<!-- STATES -->
<div id="loading" class="bg-base-100 rounded-lg border border-base-200 p-10 text-center hidden">
  <span class="loading loading-spinner loading-md"></span>
  <p class="mt-3 text-base-content/70">Loading your saved itemsâ€¦</p>
</div>

<div id="error" class="bg-base-100 rounded-lg border border-error p-6 text-center hidden">
  <p class="text-error font-semibold">Failed to load wishlist. Please try again.</p>
</div>

<div id="empty" class="bg-base-100 rounded-lg border border-base-200 p-10 text-center hidden">
  <p class="text-base-content/70">No saved items yet.</p>
</div>



<!-- GRID -->
<div id="grid" class="grid grid-cols-1 xs:grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-6 px-2 sm:px-0 hidden"></div>

<!-- similar to todays pick -->
<script>
  (function () {
    'use strict';

    const CONFIG = JSON.parse(document.getElementById('mp-config').textContent || '{}');
    const LIST_URL = CONFIG.apiWishlistListings;
    const TOGGLE_URL = CONFIG.apiToggleWishlist;
    const DETAIL_PATTERN = CONFIG.detailUrlPattern;
    const IS_AUTHENTICATED = !!CONFIG.isAuthenticated;
    const CURRENT_USER_ID = CONFIG.currentUserId ?? null;

    const els = {
      grid: document.getElementById('grid'),
      loading: document.getElementById('loading'),
      error: document.getElementById('error'),
      empty: document.getElementById('empty'),
    };

    function showSection({ loading = false, error = false, empty = false, grid = false }) {
      els.loading.classList.toggle('hidden', !loading);
      els.error.classList.toggle('hidden', !error);
      els.empty.classList.toggle('hidden', !empty);
      els.grid.classList.toggle('hidden', !grid);
    }

    function idr(n) {
      return new Intl.NumberFormat('id-ID', {
        style: 'currency', currency: 'IDR', maximumFractionDigits: 0
      }).format(Number(n || 0));
    }
    const chipCls = (c) => c === 'BRAND_NEW' ? 'bg-lime-400 text-[#3F6212]' : 'bg-orange-300 text-[#7C2D12]';
    const chipLbl = (c) => c === 'BRAND_NEW' ? 'Brand New' : 'Used';

    function cardHtml(item) {
      const idStr = String(item.id);
      const title = item.title || '';
      const img = item.image_url || '';
      const loc = item.location || '';
      const detailUrl = DETAIL_PATTERN.replace('00000000-0000-0000-0000-000000000000', idStr);

      const ownerField = item.owner_id ?? item.owner ?? item.user ?? null;
      const IS_OWNER = IS_AUTHENTICATED && CURRENT_USER_ID != null && String(ownerField) === String(CURRENT_USER_ID);

      let buttonSection = `
        <div class="mt-3 flex flex-col gap-2 z-20 relative pointer-events-auto">
          <a href="${detailUrl}"
             class="btn w-full bg-lime-500 border-lime-500 hover:bg-lime-600 hover:border-lime-600 text-white">
            View Details
          </a>
        </div>
      `;
      if (IS_OWNER) {
        buttonSection = `
          <div class="mt-3 flex flex-col sm:flex-row gap-2">
            <button type="button"
                    class="btn flex-1 border-gray-300 text-gray-700 hover:bg-gray-50 edit-btn"
                    data-id="${idStr}">
              Edit
            </button>
            <button type="button"
                    class="btn flex-1 bg-rose-500 border-rose-500 hover:bg-rose-600 hover:border-rose-600 text-white delete-btn"
                    data-id="${idStr}">
              Delete
            </button>
          </div>
        `;
      }

      return `
        <article data-id="${idStr}"
                 class="relative card bg-base-100 border border-base-300/60 shadow-sm
                        hover:shadow-md hover:ring-2 hover:ring-[#A3E635] hover:border-[#A3E635]/60 hover:bg-lime-50
                        transition-all duration-300 overflow-hidden rounded-[16px] w-full max-w-[422px] mx-auto"
                 style="min-height:420px;">
          <figure class="h-[220px] sm:h-[300px] lg:h-[320px] overflow-hidden">
            <a href="${detailUrl}" aria-label="Open ${title}">
              <img src="${img}" alt="${title}" class="w-full h-full object-cover" loading="lazy" decoding="async"/>
            </a>
          </figure>

          <div class="absolute top-3 right-3 z-20">
            <button class="wishlist-btn grid place-items-center w-9 h-9 rounded-full bg-white/90 shadow ring-1 ring-black/5 text-rose-500 pointer-events-auto"
                    aria-pressed="true" title="Remove" data-id="${idStr}">
              <svg viewBox="0 0 28 28" class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <path d="M14 24.9083L12.3083 23.3683C6.3 17.92 2.33333 14.315 2.33333 9.91667C2.33333 6.31167 5.15666 3.5 8.74999 3.5C10.78 3.5 12.7283 4.445 14 5.92667C15.2717 4.445 17.22 3.5 19.25 3.5C22.8433 3.5 25.6667 6.31167 25.6667 9.91667C25.6667 14.315 21.7 17.92 15.6917 23.3683L14 24.9083Z" fill="currentColor"/>
              </svg>
            </button>
          </div>

          <div class="p-4 sm:p-5">
            <p class="text-base sm:text-lg font-semibold mb-1">${idr(item.price)}</p>
            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2">
              <h2 class="text-sm sm:text-[20px] leading-[18px] font-semibold line-clamp-1">${title}</h2>
              <span class="px-3 py-1 text-xs sm:text-[14px] leading-[20px] font-semibold rounded-full ${chipCls(item.condition)}">
                ${chipLbl(item.condition)}
              </span>
            </div>
            <div class="mt-2 text-xs sm:text-sm text-base-content/70 flex items-center gap-1.5">
              <i data-lucide="map-pin" class="w-4 h-4"></i>
              <span class="truncate">${loc}</span>
            </div>

            ${buttonSection}
          </div>
        </article>
      `;
    }

    // fetch JSON
    async function fetchJson(url, opts = {}) {
      const r = await fetch(url, {
        credentials: 'same-origin',
        headers: { 'Accept': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
        ...opts
      });
      const ct = (r.headers.get('content-type') || '').toLowerCase();
      if (!r.ok || !ct.includes('application/json')) {
        const text = await r.text().catch(() => '');
        throw new Error(`Bad response (${r.status}). ${text.slice(0, 120)}`);
      }
      return r.json();
    }

    async function fetchAndRender() {
      try {
        showSection({ loading: true });

        if (!LIST_URL) {
          console.error('Missing CONFIG.apiWishlistListings');
          showSection({ error: true });
          return;
        }

        const raw = await fetchJson(LIST_URL);
        const data = Array.isArray(raw)
          ? raw.map(o => (o && typeof o === 'object'
              ? (o.fields ? ({ id: o.pk ?? o.fields.id, ...o.fields }) : o)
              : o))
          : [];

        els.grid.innerHTML = '';
        if (!data.length) {
          showSection({ empty: true });
        } else {
          els.grid.innerHTML = data.map(cardHtml).join('');
          try {
            if (window.lucide && typeof window.lucide.createIcons === 'function') {
              window.lucide.createIcons();
            }
          } catch (e) { console.warn('Lucide init error:', e); }
          showSection({ grid: true });
        }
      } catch (err) {
        console.error('Wishlist load error:', err);
        showSection({ error: true });
      }
    }

    // remove from wishlist
    els.grid.addEventListener('click', async (e) => {
      const btn = e.target.closest('.wishlist-btn');
      if (!btn) return;
      e.stopPropagation();

      const id = btn.dataset.id;
      const card = btn.closest('article[data-id]');
      if (!id || !card) return;

      card.remove();
      if (!els.grid.querySelector('article[data-id]')) showSection({ empty: true });

      try {
        const fd = new FormData();
        fd.append('listing_id', id);
        await fetchJson(TOGGLE_URL, { method: 'POST', body: fd });
        window.showToast && showToast('Removed from wishlist', '', 'normal');
      } catch (err) {
        console.error('Toggle wishlist error:', err);
        els.grid.insertAdjacentHTML('afterbegin', card.outerHTML);
        window.showToast && showToast('Wishlist error', 'Please try again', 'error');
      }
    }, { passive: true });

    // edit
    els.grid.addEventListener('click', (e) => {
      const btn = e.target.closest('.edit-btn');
      if (!btn) return;
      e.preventDefault();
      const id = btn.dataset.id;
      if (window.showListingModal) window.showListingModal();
      document.dispatchEvent(new CustomEvent('listing:edit-request', { detail: { id } }));
    });

    // delete
    function getCSRFToken() {
      const m = document.cookie.match(/(?:^|;)\s*csrftoken=([^;]+)/);
      return m ? decodeURIComponent(m[1]) : '';
    }
    els.grid.addEventListener('click', async (e) => {
      const btn = e.target.closest('.delete-btn');
      if (!btn) return;
      e.preventDefault();

      const id = btn.dataset.id;
      if (!confirm('Are you sure you want to delete this listing?')) return;

      try {
        const res = await fetch(`/marketplace/listing/${id}/delete-ajax/`, {
          method: 'POST',
          headers: { 'X-CSRFToken': getCSRFToken(), 'Accept': 'application/json' },
        });
        const data = await res.json();
        if (data.status === 'deleted') {
          const card = btn.closest('.card');
          card?.classList.add('opacity-0','scale-95','transition-all','duration-300');
          setTimeout(() => {
            card?.remove();
            if (!els.grid.querySelector('article[data-id]')) showSection({ empty: true });
          }, 200);
          window.showToast && showToast('Listing deleted', '', 'success');
        } else {
          alert('Failed to delete listing');
        }
      } catch (err) {
        console.error(err);
        alert('Error deleting listing');
      }
    });

    // init
    fetchAndRender();
  })();

  (function () {
    const link = document.querySelector('a[href$="{% url "marketplace_module:todays_pick" %}"]');
    if (!link) return;
    try {
      const ref = document.referrer || '';
      if (ref.includes('{% url "marketplace_module:todays_pick" %}')) {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          history.back();
        });
      }
    } catch (_) { }
  })();
</script>
{% endblock %}