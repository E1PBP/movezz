{% extends 'base_marketplace.html' %}
{% load static %}

{% block marketplace_content %}
<h1 class="text-2xl sm:text-3xl font-semibold tracking-tight mb-6">My Wishlist</h1>

<script id="mp-config" type="application/json">
  {{ page_config_json|safe }}
</script>

<!-- STATES -->
<div id="loading" class="bg-base-100 rounded-lg border border-base-200 p-10 text-center hidden">
  <span class="loading loading-spinner loading-md"></span>
  <p class="mt-3 text-base-content/70">Loading your saved itemsâ€¦</p>
</div>

<div id="error" class="bg-base-100 rounded-lg border border-error p-6 text-center hidden">
  <p class="text-error font-semibold">Failed to load wishlist. Please try again.</p>
</div>

<div id="empty" class="bg-base-100 rounded-lg border border-base-200 p-10 text-center hidden">
  <p class="text-base-content/70">No saved items yet.</p>
</div>

<!-- GRID -->
<div id="grid" class="grid grid-cols-1 xs:grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-6 px-2 sm:px-0 hidden"></div>

<script>
  (function () {
    'use strict';

    const CONFIG = JSON.parse(document.getElementById('mp-config').textContent || '{}');
    const LIST_URL = CONFIG.apiWishlistListings;
    const TOGGLE_URL = CONFIG.apiToggleWishlist;
    const DETAIL_PATTERN = CONFIG.detailUrlPattern;

    const els = {
      grid: document.getElementById('grid'),
      loading: document.getElementById('loading'),
      error: document.getElementById('error'),
      empty: document.getElementById('empty'),
    };

    function showSection({ loading = false, error = false, empty = false, grid = false }) {
      els.loading.classList.toggle('hidden', !loading);
      els.error.classList.toggle('hidden', !error);
      els.empty.classList.toggle('hidden', !empty);
      els.grid.classList.toggle('hidden', !grid);
    }

    function idr(n) {
      return new Intl.NumberFormat('id-ID', {
        style: 'currency', currency: 'IDR', maximumFractionDigits: 0
      }).format(Number(n || 0));
    }
    const chipCls = (c) => c === 'BRAND_NEW' ? 'bg-lime-400 text-[#3F6212]' : 'bg-orange-300 text-[#7C2D12]';
    const chipLbl = (c) => c === 'BRAND_NEW' ? 'Brand New' : 'Used';

    function cardHtml(item) {
      const idStr = String(item.id);
      const title = item.title || '';
      const img = item.image_url || '';
      const loc = item.location || '';
      const detailUrl = CONFIG.detailUrlPattern.replace(
        '00000000-0000-0000-0000-000000000000',
        String(item.id)
      );


      return `
  <article data-id="${idStr}"
           class="relative card bg-base-100 border border-base-300/60 shadow-sm hover:shadow-md hover:ring-1 hover:ring-base-300 transition-all duration-300 overflow-hidden rounded-[16px] w-full max-w-[422px] mx-auto"
           style="height:447px;">
    <a href="${detailUrl}" class="absolute inset-0 z-10" aria-label="Open ${title}"></a>

    <figure class="m-0 h-[220px] sm:h-[320px] lg:h-[340px] overflow-hidden pointer-events-none">
      <img src="${img}" alt="${title}" class="w-full h-full object-cover" loading="lazy" decoding="async" />
    </figure>

    <div class="absolute top-3 right-3 z-20">
      <button class="wishlist-btn grid place-items-center w-9 h-9 rounded-full bg-white/90 shadow ring-1 ring-black/5 text-rose-500 pointer-events-auto"
              aria-pressed="true" title="Remove" data-id="${idStr}">
        <svg viewBox="0 0 28 28" class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <path d="M14 24.9083L12.3083 23.3683C6.3 17.92 2.33333 14.315 2.33333 9.91667C2.33333 6.31167 5.15666 3.5 8.74999 3.5C10.78 3.5 12.7283 4.445 14 5.92667C15.2717 4.445 17.22 3.5 19.25 3.5C22.8433 3.5 25.6667 6.31167 25.6667 9.91667C25.6667 14.315 21.7 17.92 15.6917 23.3683L14 24.9083Z" fill="currentColor"/>
        </svg>
      </button>
    </div>

    <div class="p-3 sm:p-4 pt-3 pb-3 pointer-events-none" style="height:107px;">
      <p class="text-base sm:text-[20px] leading-[24px] sm:leading-[28px] font-semibold mb-1">${idr(item.price)}</p>
      <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2">
        <h2 class="text-sm sm:text-[18px] leading-[18px] font-semibold line-clamp-1">${title}</h2>
        <span class="px-3 py-1 text-xs sm:text-[14px] leading-[18px] font-semibold rounded-full ${chipCls(item.condition)}">
          ${chipLbl(item.condition)}
        </span>
      </div>
      <div class="mt-2 text-xs sm:text-sm text-base-content/70">
        <span class="truncate">${loc}</span>
      </div>
    </div>
  </article>
`;
    }

    // fetch JSON
    async function fetchJson(url, opts = {}) {
      const r = await fetch(url, {
        credentials: 'same-origin',
        headers: { 'Accept': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
        ...opts
      });
      // check if response is JSON
      const ct = (r.headers.get('content-type') || '').toLowerCase();
      if (!r.ok || !ct.includes('application/json')) {
        const text = await r.text().catch(() => '');
        throw new Error(`Bad response (${r.status}). ${text.slice(0, 120)}`);
      }
      return r.json();
    }

    async function fetchAndRender() {
      try {
        showSection({ loading: true });
        const raw = await fetchJson(LIST_URL);
        const data = Array.isArray(raw) ? raw.map(o => ({ id: o.pk, ...o.fields })) : [];

        els.grid.innerHTML = '';
        if (!data.length) {
          showSection({ empty: true });
        } else {
          els.grid.innerHTML = data.map(cardHtml).join('');
          if (window.lucide) window.lucide.createIcons();
          showSection({ grid: true });
        }
      } catch (err) {
        console.error('Wishlist load error:', err);
        showSection({ error: true });
      }
    }

    // remove from wishlist
    els.grid.addEventListener('click', async (e) => {
      const btn = e.target.closest('.wishlist-btn');
      if (!btn) return;
      e.stopPropagation();

      const id = btn.dataset.id;
      const card = btn.closest('article[data-id]');
      if (!id || !card) return;

      card.remove();
      if (!els.grid.querySelector('article')) showSection({ empty: true });

      try {
        const fd = new FormData();
        fd.append('listing_id', id);

        await fetchJson(TOGGLE_URL, { method: 'POST', body: fd });
        window.showToast && showToast('Removed from wishlist', '', 'normal');
      } catch (err) {
        console.error('Toggle wishlist error:', err);
        els.grid.insertAdjacentHTML('afterbegin', card.outerHTML);
        window.showToast && showToast('Wishlist error', 'Please try again', 'error');
      }
    }, { passive: true });

    fetchAndRender();
  })();
</script>
{% endblock %}