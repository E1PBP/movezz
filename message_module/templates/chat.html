{% extends "base.html" %} {% load static %} {% block content %}

<div
  id="chat-root"
  class="drawer lg:drawer-open h-[calc(100dvh-112px)] overflow-hidden border rounded-2xl" 
>
  {% comment %} mobile drawer area {% endcomment %}
  <input id="chat-drawer" type="checkbox" class="drawer-toggle" />
  {% comment %} main chat aera {% endcomment %}
  <div
    class="drawer-content flex flex-col h-[calc(100dvh-100px)] overflow-hidden"
  >
    {% if selected_conversation %} {% comment %} chat header {% endcomment %}
    <div
      class="flex items-center justify-between lg:justify-start gap-3 bg-base-600 px-4 py-4 sticky top-0 z-0 shrink-0"
    >
      <label for="chat-drawer" class="btn btn-ghost btn-circle lg:hidden">
        <i data-lucide="menu" class="w-5 h-5"></i>
      </label>
      {% with prof=selected_conversation.other_user.profile %}
        {% if prof.avatar_url %}
        <img
          src="{{ prof.avatar_url.url }}"
          class="w-10 h-10 rounded-full object-cover"
          alt="{{ prof.display_name|default:selected_conversation.other_user.username }}"
        />
        {% else %}
        <div
          class="w-10 h-10 rounded-full bg-primary text-primary-content flex items-center justify-center"
        >
          <span class="text-sm font-bold">
            {{ prof.display_name|default:selected_conversation.other_user.username|first|upper }}
          </span>
        </div>
        {% endif %}
      {% endwith %}
      <div class="flex-1">
        <h2 class="font-semibold text-lg">
          {{ selected_conversation.other_user.profile.display_name }}
        </h2>
        <p class="text-xs text-base-content/60">
          @{{ selected_conversation.other_user.username|lower }}
        </p>
      </div>
    </div>

    {% comment %} chat messahe area {% endcomment %}
    <div
      id="chat-messages"
      class="flex-1 min-h-0 overflow-y-auto overscroll-contain p-4 space-y-4 bg-base-100 scroll-pb-24"
    >
      {% for msg in messages %}

      <div
        class="flex {% if msg.sender == request.user %}justify-end{% else %}justify-start{% endif %}"
        data-id="{{ msg.id }}"
      >
        <div class="flex gap-2 max-w-xs lg:max-w-md">
          {% if msg.sender != request.user %}
          {% with prof=msg.sender.profile %}
          {% if prof.avatar_url %}
          <img
            src="{{ prof.avatar_url.url }}"
            class="w-8 h-8 rounded-full object-cover flex-shrink-0"
            alt="{{ prof.display_name|default:msg.sender.username }}"
          />
          {% else %}
          <div
            class="w-8 h-8 rounded-full bg-primary text-primary-content flex items-center justify-center flex-shrink-0"
          >
            <span class="text-[11px] font-bold">
              {{ prof.display_name|default:msg.sender.username|first|upper }}
            </span>
          </div>
          {% endif %} {% endwith %} {% endif %}

          <div
            class="flex flex-col {% if msg.sender == request.user %}items-end{% endif %}"
          >
            {% if msg.body %}
            <p
              class="px-4 py-2 rounded-2xl break-words text-white {% if msg.sender == request.user %}bg-lime-500 rounded-br-none{% else %}bg-[#374151] rounded-bl-none{% endif %}"
            >
              {{ msg.body }}
            </p>
            {% endif %} {% if msg.image %}
            <a
              href="{{ msg.image.url }}"
              target="_blank"
              rel="noopener"
              class="rounded-2xl overflow-hidden block mt-1"
            >
              <img
                src="{{ msg.image.url }}"
                alt="image"
                class="max-w-[260px] lg:max-w-[360px] rounded-2xl border"
              />
            </a>
            {% endif %}

            <span class="text-xs text-base-content/50 mt-1 px-2">
              {{ msg.created_at|date:"Y-m-d H:i" }}
            </span>
          </div>
        </div>
      </div>

      {% endfor %}
    </div>

    <div class="bg-base-100 pb-7 p-4 shrink-0">
      <form
        id="chat-form"
        class="flex items-center gap-2"
        enctype="multipart/form-data"
      >
        {% csrf_token %}
        <label
          for="image-input"
          id="pick-image"
          class="btn btn-ghost btn-circle"
        >
          <i data-lucide="image" class="w-5 h-5"></i>
        </label>
        <input
          type="file"
          id="image-input"
          name="image"
          accept="image/*"
          class="hidden"
        />

        <div
          id="image-preview"
          class="hidden flex-col items-center gap-1 shrink-0 px-2 py-1 rounded-xl border bg-base-200 max-w-[100px]"
        >
          {% comment %} image preview with js {% endcomment %}
        </div>

        <input
          type="text"
          id="chat-input"
          name="message"
          placeholder=""
          class="input input-bordered flex-1 focus:outline-none focus:ring-2 focus:ring-lime-500"
          suggest="off"
          autocomplete="off"
        />

        <button
          type="submit"
          class="btn btn-circle btn-primary bg-lime-500 border-lime-500 hover:bg-lime-600 hover:border-lime-600"
        >
          <i data-lucide="send" class="w-5 h-5"></i>
        </button>
      </form>
    </div>

    {% else %}


    <div class="flex-1 flex flex-col items-center justify-center gap-4 p-4">
      <div class="text-center">
        <h2 class="text-2xl font-bold mb-2">Select a message</h2>

        <p class="text-base-content/60 mb-6">
          Choose from your existing conversations or start a new one
        </p>
      </div>

      <label
        for="new-convo-modal"
        class="btn btn-primary bg-lime-500 border-lime-500 hover:bg-lime-600 hover:border-lime-600 text-white"
      >
        <i data-lucide="plus" class="w-5 h-5"></i>

        Start A New Conversation
      </label>
    </div>

    {% endif %}
  </div>

  {% comment %} sidebar conversation drawer {% endcomment %}
  <div class="drawer-side lg:drawer-side z-10">
    <label for="chat-drawer" class="drawer-overlay"></label>
    <aside
      class="w-full sm:w-80 bg-base-100 h-[calc(100dvh-110px)] flex flex-col overflow-hidden"
    >
      {% comment %} sidebar header {% endcomment %}
      <div class="p-4 sticky top-0 bg-base-100">
        <h2 class="text-xl font-bold mb-4">Messages</h2>
        <div class="form-control">
          <input
            type="text"
            id="search"
            placeholder="Search for account..."
            class="input input-bordered input-sm focus:outline-none focus:ring-2 focus:ring-lime-500"
          />
        </div>
      </div>

      {% comment %} conversation list {% endcomment %}
      <ul class="flex-1 min-h-0 overflow-y-auto overscroll-contain p-2">
        {% for convo in conversations %}
        <li class="mb-2">
          <a
            href="{% url 'message_module:chat_view' convo.id %}"
            class="flex items-center gap-3 p-3 rounded-xl transition-all {% if selected_conversation and convo.id == selected_conversation.id %}bg-gray-200 text-lime-900{% else %}hover:bg-base-200{% endif %}"
          >
            <div class="relative flex-shrink-0">
              {% with prof=convo.other_user.profile %} {% if prof.avatar_url %}
              <img
                src="{{ prof.avatar_url.url }}"
                class="w-12 h-12 rounded-full object-cover"
                alt="{{ prof.display_name|default:convo.other_user.username }}"
              />
              {% else %}
              <div
                class="w-12 h-12 rounded-full bg-primary text-primary-content flex items-center justify-center"
              >
                <span class="text-base font-bold">
                  {{ prof.display_name|default:convo.other_user.username|first|upper }}
                </span>
              </div>
              {% endif %}
              {% endwith %}
            </div>
            <div class="flex-1 min-w-0">
              <p class="font-semibold truncate">
                {{ convo.other_user.profile.display_name }}
              </p>
              <p class="text-sm text-base-content/60 truncate">
                {{ convo.last_message_preview|default:"No messages yet" }}
              </p>
            </div>
          </a>
        </li>

        {% empty %}

        <li class="p-4 text-center text-base-content/60">
          <p>No conversations yet.</p>
        </li>

        {% endfor %}
      </ul>

      <div class="p-4">
        <label
          for="new-convo-modal"
          class="btn btn-block btn-outline btn-sm border-lime-500 text-lime-500 hover:bg-lime-500 hover:border-lime-500 hover:text-white"
        >
          <i data-lucide="plus" class="w-4 h-4"></i>

          New Chat
        </label>
      </div>
    </aside>
  </div>
</div>

<input type="checkbox" id="new-convo-modal" class="modal-toggle" />

<div class="modal" role="dialog">
  <div class="modal-box w-full max-w-md rounded-2xl">
    <h2 class="text-lg font-bold mb-4">Start a new conversation</h2>

    <div class="form-control mb-4">
      <input
        type="text"
        id="user-search"
        placeholder="Search for account..."
        class="input input-bordered focus:outline-none focus:ring-2 focus:ring-lime-500"
      />
    </div>

    <div class="max-h-64 overflow-y-auto space-y-2">
      {% for u in users %}

      <form method="POST" class="w-full">
        {% csrf_token %}

        <button
          name="username"
          value="{{ u.username }}"
          type="submit"
          class="flex items-center gap-3 w-full p-3 rounded-xl hover:bg-base-200 transition-all text-left"
        >
          <img
            src="{{ u.profile.avatar_url.url|default:'/static/img/default-avatar.png' }}"
            class="w-10 h-10 rounded-full object-cover flex-shrink-0"
            alt="{{ u.username }}"
          />

          <div class="flex-1 min-w-0">
            <p class="font-medium truncate">{{u.profile.display_name}}</p>
            <p class="truncate">@{{ u.username }}</p>
          </div>
        </button>
      </form>

      {% empty %}

      <p class="text-base-content/60 text-sm text-center py-4">
        No users found.
      </p>

      {% endfor %}
    </div>

    <div class="modal-action mt-6">
      <label for="new-convo-modal" class="btn btn-ghost">Cancel</label>
    </div>
  </div>

  <label class="modal-backdrop" for="new-convo-modal">Close</label>
</div>

<script>
  (function () {
    const root = document.getElementById("chat-root");
    const nav = document.querySelector("nav");
    const main = document.querySelector("main");
    if (!root || !nav || !main) return;

    function setChatHeight() {
      const cs = getComputedStyle(main);
      const pt = parseFloat(cs.paddingTop) || 0;
      const pb = parseFloat(cs.paddingBottom) || 0;
      const chromeH = nav.offsetHeight + pt + pb;
      root.style.height = `calc(100dvh - ${chromeH}px)`;
    }

    setChatHeight();
    addEventListener("resize", setChatHeight);
    addEventListener("orientationchange", setChatHeight);
    new ResizeObserver(setChatHeight).observe(nav);
    new ResizeObserver(setChatHeight).observe(main);
  })();

  const conversationId = "{{ selected_conversation.id|default:'' }}";
  const chatMessages = document.getElementById("chat-messages");
  const chatForm = document.getElementById("chat-form");
  const chatInput = document.getElementById("chat-input");
  const imageInput = document.getElementById("image-input");
  const imagePreview = document.getElementById("image-preview");
  const pickImageBtn = document.getElementById("pick-image");

  // get last message ID for polling
  let lastMsgId = "{{ last_message_id|default:'' }}";
  let polling = false;
  let _previewUrl = null;

  // this will clear the image preview UI and optionally the input file
  function clearImagePreview(opts = { keepInput: false }) {
    const keepInput = !!opts.keepInput;

    if (_previewUrl) {
      URL.revokeObjectURL(_previewUrl);
      _previewUrl = null;
    }
    if (!keepInput && imageInput) {
      imageInput.value = "";
    }
    if (imagePreview) {
      imagePreview.innerHTML = "";
      imagePreview.classList.add("hidden");
    }
  }

  // CSRF helper function
  function getCookie(name) {
    const m = document.cookie.match("(^|;)\\s*" + name + "\\s*=\\s*([^;]+)");
    return m ? m.pop() : "";
  }
  const csrftoken = getCookie("csrftoken");

  // send message handler
  if (chatForm && conversationId) {
    chatForm.addEventListener("submit", async (e) => {
      e.preventDefault();

      const hasText = (chatInput.value || "").trim().length > 0;
      const hasImage =
        imageInput && imageInput.files && imageInput.files.length > 0;

      if (!hasText && !hasImage) return;

      const formData = new FormData();
      if (hasText) formData.append("message", chatInput.value.trim());
      if (hasImage) formData.append("image", imageInput.files[0]);

      try {
        const res = await fetch(`/messages/${conversationId}/send/`, {
          method: "POST",
          headers: { "X-CSRFToken": csrftoken },
          body: formData,
        });

        if (res.ok) {
          chatInput.value = "";
          clearImagePreview();
          await pollMessages(true);
        } else {
          console.error("Send failed", await res.text());
        }
      } catch (err) {
        console.error("Send failed:", err);
      }
    });
  }

  // this will format bytes into KB/MB. if < 1 MB, show in KB
  function prettySize(bytes) {
    const mb = bytes / (1024 * 1024);
    if (mb >= 1) return mb.toFixed(2) + " MB";
    const kb = bytes / 1024;
    return kb.toFixed(0) + " KB";
  }

  // handle image selection and preview
  function handleImagePick() {
    clearImagePreview({ keepInput: true });

    const file = imageInput?.files?.[0];
    if (!file) return;

    const okTypes = ["image/jpeg", "image/png", "image/webp", "image/gif"];
    if (!okTypes.includes(file.type)) {
      alert("Tipe file tidak didukung.");
      imageInput.value = "";
      return;
    }
    const maxSizeMB = 10;
    if (file.size > maxSizeMB * 1024 * 1024) {
      alert(`Ukuran gambar terlalu besar (> ${maxSizeMB} MB).`);
      imageInput.value = "";
      return;
    }

    _previewUrl = URL.createObjectURL(file);
    imagePreview.innerHTML = `
      <div class="relative">
        <img src="${_previewUrl}" alt="preview" class="w-20 h-20 object-cover rounded-2xl border" />
        <button type="button" id="btn-clear-image" class="btn btn-xs btn-circle absolute -top-2 -right-2">✕</button>
      </div>
      <div class="text-xs opacity-70 max-w-[180px]">
        <div class="truncate">${file.name}</div>
        <div>${prettySize(file.size)}</div>
      </div>`;
    imagePreview.classList.remove("hidden");
    document
      .getElementById("btn-clear-image")
      ?.addEventListener("click", () => clearImagePreview());
  }

  imageInput?.addEventListener("change", handleImagePick);
  imageInput?.addEventListener("input", handleImagePick);

  // polling function to get new messages
  async function pollMessages(scroll = false) {
    if (!conversationId || polling) return;
    polling = true;

    try {
      const res = await fetch(
        `/messages/${conversationId}/poll/?last_msg_id=${encodeURIComponent(
          lastMsgId || ""
        )}`
      );
      const data = await res.json();

      if (Array.isArray(data.messages) && data.messages.length > 0) {
        data.messages.forEach((msg) => {
          if (document.querySelector(`[data-id="${msg.id}"]`)) return;

          const wrapper = document.createElement("div");
          wrapper.dataset.id = msg.id;
          wrapper.className = `flex ${
            msg.is_self ? "justify-end" : "justify-start"
          }`;

          // build message parts bubbles
          const parts = [];
          if (msg.body) {
            parts.push(`
                <p class="px-4 py-2 rounded-2xl break-words ${
                  msg.is_self
                    ? "bg-lime-500 text-white rounded-br-none"
                    : "bg-base-200 text-base-content rounded-bl-none"
                }">${msg.body}</p>
              `);
          }
          if (msg.image_url) {
            parts.push(`
                <a href="${msg.image_url}" target="_blank" rel="noopener"
                   class="rounded-2xl overflow-hidden block mt-1">
                  <img src="${msg.image_url}" alt="image"
                       class="max-w-[260px] lg:max-w-[360px] rounded-2xl border" />
                </a>
              `);
          }

          wrapper.innerHTML = `
              <div class="flex gap-2 max-w-xs lg:max-w-md">
                ${
                  !msg.is_self
                    ? `<img src="${msg.sender_avatar}" class="w-8 h-8 rounded-full object-cover flex-shrink-0" alt="${msg.sender}">`
                    : ""
                }
                <div class="flex flex-col ${msg.is_self ? "items-end" : ""}">
                  ${parts.join("")}
                  <span class="text-xs text-base-content/50 mt-1 px-2">${
                    msg.created_at
                  }</span>
                </div>
              </div>
            `;
          chatMessages.appendChild(wrapper);
        });

        lastMsgId = data.messages[data.messages.length - 1].id;
        if (scroll) chatMessages.scrollTop = chatMessages.scrollHeight;
      }
    } catch (err) {
      console.error("Polling error:", err);
    } finally {
      polling = false;
    }
  }

  // ensure image input event is bound only once
  if (!window.__imgPreviewBound__) {
    window.__imgPreviewBound__ = true;
    imageInput?.addEventListener("change", handleImagePick);
    imageInput?.addEventListener("input", handleImagePick);
  }
  // start polling
  if (conversationId) {
    pollMessages(true);
    setInterval(() => pollMessages(), 1000);
  }
  if (chatMessages) chatMessages.scrollTop = chatMessages.scrollHeight;
</script>

{% endblock %}
